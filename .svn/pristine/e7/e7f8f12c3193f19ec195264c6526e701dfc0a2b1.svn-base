package kr.or.ddit.login.service;

import java.security.SecureRandom;

import javax.inject.Inject;

import org.springframework.stereotype.Service;

import kr.or.ddit.login.dao.LoginDAO;
import kr.or.ddit.vo.groupware.EmployeeVO;
import lombok.extern.slf4j.Slf4j;
import net.nurigo.sdk.NurigoApp;
import net.nurigo.sdk.message.model.Message;
import net.nurigo.sdk.message.request.SingleMessageSendingRequest;
import net.nurigo.sdk.message.response.SingleMessageSentResponse;
import net.nurigo.sdk.message.service.DefaultMessageService;

@Service
@Slf4j
public class SendCertiMessageImpl implements SendCertiMessage{

	@Inject
	LoginDAO dao;
	
	final DefaultMessageService messageService;

	public SendCertiMessageImpl() {
		this.messageService = NurigoApp.INSTANCE.initialize("NCS9ZQYDTT6C7I6N", "F0UYYWY6GTA2LLUTUQZBPSRVVUYQSA9K",
				"https://api.coolsms.co.kr");
	}
	
	String crtfNo;
	@Override
	public String generateCertificationNumber() {
		int length = 6; // 6자리 길이로
		String characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
		StringBuilder code = new StringBuilder();
		SecureRandom random = new SecureRandom();

		for (int i = 0; i < length; i++) {
			int randomIndex = random.nextInt(characters.length());
			char randomChar = characters.charAt(randomIndex);
			code.append(randomChar);
		}
		crtfNo = code.toString();
		log.info("인증번호 : {}", code.toString());
		return code.toString();
	}

	@Override
	public SingleMessageSentResponse sendMessage(String inputEmpTelno) {
		Message message = new Message();

		// 번호 형태 : 하이픈 없이, 01012345678
		message.setFrom("01040322635"); // 발신번호
		message.setTo(inputEmpTelno); // 수신번호 //직원의 번호

		String tempPassword = generateCertificationNumber(); // 인증번호 발급
		String sendText = String.format("[AllRounder] 인증번호는 %s 입니다.", tempPassword);
		message.setText(sendText);

		SingleMessageSentResponse response = this.messageService.sendOne(new SingleMessageSendingRequest(message));
		log.info("발송메세지 : {}", sendText);
		log.info("발송메세지 : {}", response);
		return response;
	}

	@Override
	public int updateCertiNum(EmployeeVO employeeVO) {
		crtfNo = "AAA111";
		
		employeeVO.setEmpCrtfcNo(crtfNo);
		return dao.updateEmpCertfNo(employeeVO);
	}
}
